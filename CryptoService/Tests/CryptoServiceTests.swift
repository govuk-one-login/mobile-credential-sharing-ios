@testable import CredentialSharingUI
import CryptoKit
@testable import CryptoService
import Foundation
import SwiftCBOR
import Testing

@Suite
struct CryptoServiceTests {
    // swiftlint:disable:next line_length
    static let sessionEstablishment: [UInt8] = [162, 106, 101, 82, 101, 97, 100, 101, 114, 75, 101, 121, 216, 24, 88, 75, 164, 1, 2, 32, 1, 33, 88, 32, 148, 104, 139, 189, 165, 211, 88, 186, 222, 173, 171, 223, 146, 89, 148, 133, 16, 118, 75, 144, 201, 103, 47, 147, 81, 38, 56, 20, 168, 5, 243, 140, 34, 88, 32, 129, 215, 27, 171, 10, 64, 214, 65, 51, 207, 17, 201, 211, 198, 212, 236, 124, 94, 50, 105, 228, 220, 43, 0, 116, 189, 160, 129, 175, 170, 235, 123, 100, 100, 97, 116, 97, 89, 3, 73, 41, 128, 47, 91, 235, 228, 87, 211, 142, 229, 77, 230, 178, 168, 232, 140, 93, 177, 12, 181, 163, 59, 215, 153, 134, 138, 82, 154, 191, 160, 228, 161, 81, 41, 36, 81, 65, 197, 176, 178, 54, 100, 246, 142, 222, 167, 243, 14, 2, 15, 32, 197, 251, 135, 203, 147, 29, 162, 107, 70, 202, 59, 190, 20, 86, 32, 199, 250, 194, 92, 89, 23, 245, 155, 199, 46, 157, 206, 125, 176, 76, 148, 193, 142, 205, 99, 248, 104, 201, 0, 66, 248, 52, 200, 169, 234, 67, 244, 144, 227, 152, 246, 205, 42, 125, 218, 38, 63, 133, 54, 48, 186, 116, 43, 252, 95, 20, 88, 155, 98, 217, 100, 89, 121, 76, 73, 204, 58, 93, 220, 226, 197, 249, 191, 80, 191, 82, 43, 113, 117, 130, 20, 79, 176, 53, 149, 12, 8, 39, 21, 68, 201, 13, 35, 144, 4, 250, 59, 118, 143, 170, 78, 130, 73, 221, 76, 238, 156, 238, 232, 184, 52, 77, 89, 54, 105, 230, 194, 131, 248, 76, 70, 80, 41, 61, 99, 128, 163, 18, 141, 201, 7, 51, 212, 35, 160, 36, 114, 43, 122, 98, 191, 23, 131, 129, 117, 16, 60, 65, 38, 186, 88, 160, 77, 177, 181, 183, 245, 116, 180, 251, 178, 228, 108, 138, 197, 243, 220, 5, 73, 142, 36, 22, 156, 145, 207, 180, 48, 32, 118, 121, 192, 237, 43, 179, 117, 59, 217, 245, 121, 237, 215, 47, 159, 72, 201, 75, 144, 32, 106, 139, 85, 47, 146, 107, 176, 239, 78, 104, 182, 142, 18, 117, 193, 244, 124, 181, 109, 136, 132, 29, 40, 240, 182, 135, 183, 144, 26, 18, 223, 216, 173, 223, 71, 197, 112, 32, 229, 93, 143, 6, 248, 74, 235, 124, 247, 131, 57, 212, 42, 19, 120, 180, 55, 184, 175, 26, 181, 249, 237, 54, 12, 66, 146, 228, 170, 34, 221, 246, 194, 93, 169, 120, 116, 16, 16, 128, 204, 26, 246, 8, 127, 116, 90, 200, 88, 57, 55, 255, 136, 20, 152, 117, 24, 188, 214, 93, 165, 240, 104, 92, 114, 110, 123, 172, 223, 183, 81, 19, 205, 215, 41, 7, 171, 192, 122, 247, 94, 239, 213, 128, 82, 16, 236, 73, 114, 32, 55, 18, 68, 248, 13, 213, 72, 131, 34, 165, 88, 225, 210, 224, 219, 217, 42, 239, 29, 102, 195, 217, 166, 213, 7, 108, 79, 248, 83, 152, 94, 133, 10, 91, 60, 223, 31, 159, 49, 44, 185, 44, 108, 86, 139, 175, 7, 201, 180, 117, 5, 192, 147, 122, 101, 225, 96, 18, 36, 142, 147, 122, 190, 106, 32, 174, 118, 229, 34, 189, 75, 240, 24, 250, 29, 162, 217, 123, 58, 93, 16, 22, 220, 72, 109, 88, 43, 79, 4, 74, 16, 14, 77, 211, 108, 1, 35, 154, 128, 76, 175, 237, 7, 36, 217, 4, 217, 23, 69, 29, 21, 23, 231, 170, 239, 8, 82, 116, 0, 71, 130, 251, 220, 118, 40, 142, 140, 153, 182, 167, 129, 209, 191, 233, 168, 1, 254, 0, 90, 99, 31, 139, 8, 181, 60, 71, 77, 59, 137, 4, 139, 17, 164, 78, 115, 67, 157, 35, 205, 239, 109, 187, 159, 144, 15, 165, 126, 228, 148, 74, 49, 190, 85, 134, 195, 72, 128, 44, 66, 63, 81, 244, 70, 57, 99, 8, 48, 242, 78, 68, 249, 180, 33, 80, 105, 32, 85, 8, 150, 129, 120, 131, 7, 198, 226, 190, 141, 168, 90, 75, 83, 106, 47, 211, 58, 10, 86, 254, 160, 42, 94, 85, 254, 79, 99, 233, 98, 223, 89, 94, 233, 20, 54, 131, 11, 200, 168, 45, 49, 163, 186, 56, 75, 41, 183, 175, 49, 149, 203, 87, 30, 214, 214, 149, 139, 240, 167, 15, 255, 196, 121, 49, 191, 96, 42, 217, 46, 137, 73, 230, 172, 105, 119, 251, 191, 223, 50, 240, 105, 12, 227, 17, 150, 250, 211, 44, 45, 178, 235, 65, 232, 82, 71, 182, 138, 165, 190, 218, 51, 126, 37, 134, 217, 101, 9, 164, 244, 142, 52, 245, 97, 7, 70, 143, 187, 204, 183, 214, 209, 142, 192, 246, 185, 106, 250, 3, 6, 37, 139, 202, 128, 121, 98, 195, 65, 213, 46, 253, 89, 148, 138, 145, 79, 157, 108, 255, 203, 75, 78, 89, 92, 136, 185, 66, 118, 113, 212, 213, 141, 74, 154, 53, 17, 50, 100, 176, 16, 95, 144, 69, 69, 128, 79, 98, 109, 213, 33, 178, 123, 232, 30, 212, 205, 145, 94, 130, 198, 247, 244, 52, 200, 3, 36, 183, 165, 64, 6, 214, 3, 167, 99, 239, 176, 53, 60, 158, 197, 92, 120, 168, 240, 187, 189, 156, 57, 192, 252, 177, 233, 216, 153, 80, 150, 85, 226, 250, 40, 126, 252, 207, 168, 119, 127, 167, 189, 75, 169, 214, 229, 170, 116, 18, 195, 131, 187, 78, 129, 55, 41, 40, 117, 168, 84, 179]
    
    var sut: CryptoService
    var deviceEngagement: DeviceEngagement
    
    init() throws {
        let mockSessionDecryption = MockSessionDecryption()
        self.sut = CryptoService(sessionDecryption: mockSessionDecryption)
        // swiftlint:disable:next line_length
        self.deviceEngagement = try DeviceEngagement(from: "owBjMS4wAYIB2BhYS6QBAiABIVggYRjA9t1gxaLrXgGhwlicYZv0DiMcEk6XYsGRnrQFLtgiWCA2xjgQYWD3mVoyopVgQSxB-d20858IftBf1evzEkKjNAKBgwIBowD1AfQKUC7huHQAAUkksKGuXFLNBg8")
    }
    
    @Test("decryptSessionEstablishmentMessage increments messageCounter when successful")
    mutating func incrementsMessageCounterOnSuccess() async throws {
        // Given
        #expect(sut.messageCounter == 1)
        
        // When
        try sut.decryptSessionEstablishmentMessage(from: Data(CryptoServiceTests.sessionEstablishment), with: deviceEngagement)
        
        // Then
        #expect(sut.messageCounter == 2)
        
    }
}

class MockSessionDecryption: Decryption {
    var publicKey: P256.KeyAgreement.PublicKey = P256.KeyAgreement.PrivateKey().publicKey
    
    func decryptData(_ data: [UInt8], salt: [UInt8], encryptedWith theirPublicKey: P256.KeyAgreement.PublicKey, by parameters: any EncryptionParameters) throws -> Data {
        // So long as this function doesn't throw, it will be treated as a success
        Data()
    }
}
